<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Secure Password Manager</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Welcome, {{ current_user.username }}!</h1>
            <p>Manage your passwords securely and efficiently.</p>
        </header>

        {# Flash Messages #}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="actions">
            <a href="{{ url_for('main.add_password') }}" class="btn btn-primary">Add New Password</a>
            <a href="{{ url_for('main.logout') }}" class="btn btn-secondary">Logout</a>
        </div>

        {% if passwords %}
            <h2>Your Passwords</h2>
            <div class="search-bar">
                <input type="text" id="search" placeholder="Search passwords..." onkeyup="filterPasswords()">
            </div>
            <table class="password-table">
                <thead>
                    <tr>
                        <th>Site Name</th>
                        <th>Site URL</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for password in passwords %}
                    <tr>
                        <td>{{ password.site_name }}</td>
                        <td>
                            {% if password.site_url %}
                                <a href="{{ password.site_url }}" target="_blank">{{ password.site_url }}</a>
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td class="actions">
                            <a href="{{ url_for('main.view_password', id=password.id) }}" class="btn btn-view">View</a>
                            <a href="{{ url_for('main.edit_password', id=password.id) }}" class="btn btn-edit">Edit</a>
                            <a href="{{ url_for('main.share_password', password_id=password.id) }}" class="btn btn-share">Share</a>
                            <form action="{{ url_for('main.delete_password', id=password.id) }}" method="POST" style="display: inline;">
                                <button type="submit" class="btn btn-delete" onclick="return confirm('Are you sure you want to delete this password?')">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            {# Pagination #}
            <div class="pagination">
                {% if page > 1 %}
                    <a href="{{ url_for('main.dashboard', page=page-1) }}" class="btn btn-prev">Previous</a>
                {% endif %}
                <span>Page {{ page }} of {{ total_pages }}</span>
                {% if page < total_pages %}
                    <a href="{{ url_for('main.dashboard', page=page+1) }}" class="btn btn-next">Next</a>
                {% endif %}
            </div>
        {% else %}
            <p>No passwords found. <a href="{{ url_for('main.add_password') }}">Add a new password</a> to get started.</p>
        {% endif %}

        {# Shared Passwords Section #}
        <h2>Shared Passwords</h2>
        {% if shared_passwords %}
            <table class="shared-password-table">
                <thead>
                    <tr>
                        <th>Site Name</th>
                        <th>Expiry Time</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for shared_password in shared_passwords %}
                    <tr>
                        <td>{{ shared_password.password.site_name }}</td>
                        <td>{{ shared_password.expiry_time.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        <td>
                            {% if shared_password.is_used %}
                                Used
                            {% elif datetime.utcnow() > shared_password.expiry_time %}
                                Expired
                            {% else %}
                                Active
                            {% endif %}
                        </td>
                        <td class="actions">
                            <a href="{{ url_for('main.view_shared_password', token=shared_password.token) }}" class="btn btn-view">View Link</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No shared passwords found.</p>
        {% endif %}
    </div>

    <script>
        function filterPasswords() {
            const input = document.getElementById("search").value.toLowerCase();
            const rows = document.querySelectorAll(".password-table tbody tr");
            rows.forEach(row => {
                const siteName = row.querySelector("td:nth-child(1)").textContent.toLowerCase();
                const siteUrl = row.querySelector("td:nth-child(2)").textContent.toLowerCase();
                if (siteName.includes(input) || siteUrl.includes(input)) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        }
    </script>
</body>
</html>